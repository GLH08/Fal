# Fal.ai Imagen4 OpenAI-Compatible Cloudflare Worker

è¿™æ˜¯ä¸€ä¸ª Cloudflare Worker è„šæœ¬ï¼Œå®ƒå……å½“ Fal.ai Imagen4 å›¾åƒç”Ÿæˆæ¨¡å‹çš„ä»£ç†ï¼Œå¹¶æä¾›ä¸ OpenAI API å…¼å®¹çš„æ¥å£ã€‚è¿™ä½¿å¾—æ‚¨å¯ä»¥å°† Fal.ai Imagen4 é›†æˆåˆ°æœŸæœ› OpenAI API æ ¼å¼çš„åº”ç”¨ç¨‹åºæˆ–æœåŠ¡ä¸­ï¼Œä¾‹å¦‚å„ç§èŠå¤©æœºå™¨äººå®¢æˆ·ç«¯ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

*   **OpenAI API å…¼å®¹æ€§**:
    *   æ”¯æŒ `/v1/images/generations` ç«¯ç‚¹ç”¨äºç›´æ¥å›¾åƒç”Ÿæˆã€‚
    *   æ”¯æŒ `/v1/chat/completions` ç«¯ç‚¹ï¼Œå…è®¸é€šè¿‡èŠå¤©äº¤äº’ç”Ÿæˆå›¾åƒï¼ˆæ”¯æŒæµå¼å’Œéæµå¼å“åº”ï¼‰ã€‚
    *   æ”¯æŒ `/v1/models` ç«¯ç‚¹ï¼Œåˆ—å‡ºå¯ç”¨çš„æ¨¡å‹ï¼ˆå½“å‰ä¸º `imagen4-preview`ï¼‰ã€‚
*   **Fal.ai Imagen4 é›†æˆ**: åœ¨åç«¯ä½¿ç”¨ Fal.ai çš„ `imagen4-preview` æ¨¡å‹è¿›è¡Œå›¾åƒç”Ÿæˆã€‚
*   **çµæ´»çš„å°ºå¯¸/æ¯”ä¾‹æ§åˆ¶**:
    *   å¯ä»¥ç›´æ¥åœ¨ `/v1/images/generations` è¯·æ±‚çš„ `size` å‚æ•°ä¸­æŒ‡å®šã€‚
    *   å¯ä»¥åœ¨ `/v1/chat/completions` è¯·æ±‚çš„ `size` å‚æ•°ä¸­æŒ‡å®šã€‚
    *   **æ™ºèƒ½è¯†åˆ«èŠå¤©å†…å®¹ä¸­çš„å°ºå¯¸**: Worker å¯ä»¥ä»ç”¨æˆ·å‘é€çš„èŠå¤©æ¶ˆæ¯æ–‡æœ¬ä¸­è‡ªåŠ¨æå–å°ºå¯¸æˆ–å®½é«˜æ¯”ä¿¡æ¯ï¼ˆä¾‹å¦‚ "ç”»ä¸€åªçŒ« 9:16" æˆ– "åŸå¸‚é£æ™¯ size:1024x768"ï¼‰ã€‚
*   **Worker è®¿é—®å¯†é’¥éªŒè¯**: é€šè¿‡ `Authorization: Bearer YOUR_WORKER_ACCESS_KEY` HTTP å¤´ä¿æŠ¤ Worker ç«¯ç‚¹ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½è°ƒç”¨ã€‚
*   **æµå¼å“åº”**: å¯¹äº `/v1/chat/completions` ç«¯ç‚¹ï¼Œæ”¯æŒæµå¼å“åº”ï¼Œå¯ä»¥é€æ­¥æ˜¾ç¤ºç”Ÿæˆè¿‡ç¨‹å’Œç»“æœã€‚

## ğŸš€ éƒ¨ç½²ä¸é…ç½®

### å…ˆå†³æ¡ä»¶

1.  ä¸€ä¸ª **Cloudflare è´¦æˆ·**ã€‚
2.  ä¸€ä¸ª **Fal.ai è´¦æˆ·** å¹¶è·å–æ‚¨çš„ API å¯†é’¥ã€‚

### éƒ¨ç½²æ­¥éª¤

1.  ç™»å½•åˆ°æ‚¨çš„ Cloudflare ä»ªè¡¨æ¿ã€‚
2.  å¯¼èˆªåˆ° "Workers & Pages"ã€‚
3.  ç‚¹å‡» "åˆ›å»ºåº”ç”¨ç¨‹åº" -> "åˆ›å»º Worker"ã€‚
4.  ä¸ºæ‚¨çš„ Worker æŒ‡å®šä¸€ä¸ªåç§°ï¼ˆä¾‹å¦‚ `fal-imagen4-proxy`ï¼‰ã€‚
5.  ç‚¹å‡» "éƒ¨ç½²"ã€‚
6.  éƒ¨ç½²å®Œæˆåï¼Œç‚¹å‡» "ç¼–è¾‘ä»£ç "ã€‚
7.  å°†æä¾›çš„ `worker.js` (å³æ‚¨æ”¶åˆ°çš„å®Œæ•´è„šæœ¬) çš„å†…å®¹å¤åˆ¶å¹¶ç²˜è´´åˆ° Cloudflare Worker ç¼–è¾‘å™¨ä¸­ï¼Œæ›¿æ¢æ‰é»˜è®¤çš„ä»£ç ã€‚
8.  ç‚¹å‡» "éƒ¨ç½²" ä»¥ä¿å­˜å¹¶éƒ¨ç½²æ‚¨çš„ä»£ç ã€‚

### ç¯å¢ƒå˜é‡é…ç½®

éƒ¨ç½²ä»£ç åï¼Œæ‚¨**å¿…é¡»**åœ¨ Worker çš„è®¾ç½®ä¸­é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

1.  `FAL_API_KEY`:
    *   **å€¼**: æ‚¨çš„ Fal.ai API å¯†é’¥ã€‚
    *   **è·¯å¾„**: åœ¨ Worker è®¾ç½®é¡µé¢ -> "å˜é‡" -> "ç¯å¢ƒå˜é‡" -> "æ·»åŠ å˜é‡"ã€‚
2.  `WORKER_ACCESS_KEY`:
    *   **å€¼**: æ‚¨è‡ªå®šä¹‰çš„ä¸€ä¸ªå¼ºå¯†é’¥ï¼Œç”¨äºä¿æŠ¤å¯¹æ­¤ Worker çš„è®¿é—®ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªéšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œå¦‚ `sk-mysecretworkerkey123abc`ï¼‰ã€‚
    *   **è·¯å¾„**: åœ¨ Worker è®¾ç½®é¡µé¢ -> "å˜é‡" -> "ç¯å¢ƒå˜é‡" -> "æ·»åŠ å˜é‡"ã€‚

**é‡è¦**: ç¡®ä¿å°†è¿™äº›å˜é‡æ ‡è®°ä¸ºâ€œç§˜å¯†â€ï¼ˆå¦‚æœ Cloudflare ç•Œé¢æä¾›è¯¥é€‰é¡¹ï¼‰ï¼Œä»¥å¢å¼ºå®‰å…¨æ€§ã€‚

## ğŸ› ï¸ å¦‚ä½•ä½¿ç”¨

éƒ¨ç½²å¹¶é…ç½®å¥½ Worker åï¼Œæ‚¨å¯ä»¥é€šè¿‡å…¶å…¬å…± URLï¼ˆä¾‹å¦‚ `https://your-worker-name.your-subdomain.workers.dev`ï¼‰ä¸å®ƒè¿›è¡Œäº¤äº’ã€‚

### é€šç”¨è¦æ±‚

æ‰€æœ‰ API è¯·æ±‚éƒ½å¿…é¡»åŒ…å« `Authorization` HTTP å¤´ï¼š

`Authorization: Bearer YOUR_WORKER_ACCESS_KEY`


å°† `YOUR_WORKER_ACCESS_KEY` æ›¿æ¢ä¸ºæ‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®çš„å®é™… Worker è®¿é—®å¯†é’¥ã€‚

### 1. åˆ—å‡ºæ¨¡å‹ (`/v1/models`)

*   **æ–¹æ³•**: `GET`
*   **URL**: `https://<æ‚¨çš„Workeråœ°å€>/v1/models`
*   **å“åº”**:
    ```json
    {
      "object": "list",
      "data": [
        {
          "id": "imagen4-preview",
          "object": "model",
          "created": 1677652288, // ç¤ºä¾‹æ—¶é—´æˆ³
          "owned_by": "fal-ai",
          "permission": [],
          "root": "imagen4-preview",
          "parent": null
        }
      ]
    }
    ```

### 2. ç”Ÿæˆå›¾åƒ (`/v1/images/generations`)

*   **æ–¹æ³•**: `POST`
*   **URL**: `https://<æ‚¨çš„Workeråœ°å€>/v1/images/generations`
*   **è¯·æ±‚ä½“ (JSON)**:
    ```json
    {
      "prompt": "ä¸€åªç©¿ç€å®‡èˆªæœçš„å¯çˆ±çŒ«å’ªåœ¨æœˆçƒä¸Šå–å’–å•¡",
      "n": 1, // ç”Ÿæˆå›¾ç‰‡æ•°é‡ (Fal.ai Imagen4 æ”¯æŒ 1-4)
      "size": "16:9", // å›¾ç‰‡å°ºå¯¸/æ¯”ä¾‹ï¼Œä¾‹å¦‚ "1024x1024", "16:9", "9:16", "4:3", "3:4"
      "response_format": "url" // "url" æˆ– "b64_json"
    }
    ```
*   **å“åº” (ç¤ºä¾‹, `response_format: "url"`)**:
    ```json
    {
      "created": 1677652288,
      "data": [
        {
          "url": "https://fal.media/files/..." // ç”Ÿæˆçš„å›¾ç‰‡URL
        }
      ]
    }
    ```

### 3. é€šè¿‡èŠå¤©ç”Ÿæˆå›¾åƒ (`/v1/chat/completions`)

æ­¤ç«¯ç‚¹æ¨¡æ‹Ÿ OpenAI çš„èŠå¤©æ¥å£ï¼Œä½†ç”¨äºç”Ÿæˆå›¾åƒã€‚

*   **æ–¹æ³•**: `POST`
*   **URL**: `https://<æ‚¨çš„Workeråœ°å€>/v1/chat/completions`
*   **è¯·æ±‚ä½“ (JSON)**:

    **ç¤ºä¾‹ 1: åœ¨ JSON ä¸­æŒ‡å®šå°ºå¯¸**
    ```json
    {
      "model": "imagen4-preview",
      "messages": [
        {
          "role": "user",
          "content": "ç”»ä¸€å¹…èµ›åšæœ‹å…‹é£æ ¼çš„åŸå¸‚å¤œæ™¯"
        }
      ],
      "size": "9:16", // åœ¨è¿™é‡ŒæŒ‡å®šå°ºå¯¸
      "stream": false // true è¡¨ç¤ºæµå¼å“åº”, false è¡¨ç¤ºä¸€æ¬¡æ€§å“åº”
    }
    ```

    **ç¤ºä¾‹ 2: åœ¨èŠå¤©å†…å®¹ä¸­æŒ‡å®šå°ºå¯¸ (Worker ä¼šè‡ªåŠ¨æå–)**
    ```json
    {
      "model": "imagen4-preview",
      "messages": [
        {
          "role": "user",
          "content": "ç”»ä¸€å¹…èµ›åšæœ‹å…‹é£æ ¼çš„åŸå¸‚å¤œæ™¯ æ¯”ä¾‹:16:9" // å°ºå¯¸æŒ‡ä»¤åœ¨æ–‡æœ¬ä¸­
        }
      ],
      "stream": true
    }
    ```
    æ”¯æŒçš„èŠå¤©å†…å®¹ä¸­çš„å°ºå¯¸æŒ‡ä»¤æ ¼å¼åŒ…æ‹¬ï¼š
    *   `size:9:16` (åŠè§’/å…¨è§’å†’å·)
    *   `æ¯”ä¾‹=16/9`
    *   `aspect_ratio 1024x768`
    *   ç›´æ¥çš„æ¯”ä¾‹æˆ–å°ºå¯¸ï¼Œå¦‚ `9:16` æˆ– `1024x1024` (å¦‚æœæ–‡æœ¬ä¸­æ²¡æœ‰å…¶ä»–æ•°å­—å¹²æ‰°)

*   **å“åº” (éæµå¼, ç¤ºä¾‹)**:
    ```json
    {
      "id": "chatcmpl-...",
      "object": "chat.completion",
      "created": 1677652288,
      "model": "imagen4-preview",
      "choices": [
        {
          "index": 0,
          "message": {
            "role": "assistant",
            "content": "Generated image with prompt: \"ç”»ä¸€å¹…èµ›åšæœ‹å…‹é£æ ¼çš„åŸå¸‚å¤œæ™¯\" and aspect ratio: 16:9\n\n![Generated Image](https://fal.media/files/...)"
          },
          "finish_reason": "stop"
        }
      ],
      "usage": { ... }
    }
    ```
*   **å“åº” (æµå¼)**: å°†ä¼šæ˜¯ä¸€ç³»åˆ— `text/event-stream` äº‹ä»¶ï¼Œé€æ­¥æ˜¾ç¤ºç”ŸæˆçŠ¶æ€å’Œæœ€ç»ˆçš„å›¾ç‰‡ Markdownã€‚

## âš™ï¸ æ¨¡å‹

æ­¤ Worker å½“å‰ç¡¬ç¼–ç ä½¿ç”¨ Fal.ai çš„ `imagen4-preview` æ¨¡å‹ã€‚

## âš ï¸ é‡è¦æç¤º

*   **API å¯†é’¥å®‰å…¨**: æ‚¨çš„ `FAL_API_KEY` å’Œ `WORKER_ACCESS_KEY` éƒ½éå¸¸æ•æ„Ÿã€‚è¯·åŠ¡å¿…å°†å®ƒä»¬å­˜å‚¨ä¸º Cloudflare Worker çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶ä¸”ä¸è¦å°†å®ƒä»¬ç¡¬ç¼–ç åˆ°å…¬å¼€çš„ä»£ç åº“ä¸­æˆ–ç›´æ¥æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚
*   **é”™è¯¯å¤„ç†**: Worker ä¼šå°è¯•è¿”å›ç¬¦åˆ OpenAI API æ ¼å¼çš„é”™è¯¯å“åº”ã€‚
*   **å°ºå¯¸è¯†åˆ«çš„å±€é™æ€§**: è™½ç„¶ Worker åŠªåŠ›ä»èŠå¤©æ–‡æœ¬ä¸­è¯†åˆ«å°ºå¯¸ï¼Œä½†è¿‡äºå¤æ‚æˆ–æ¨¡ç³Šçš„è¡¨è¿°å¯èƒ½æ— æ³•è¢«æ­£ç¡®è§£æã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå»ºè®®é€šè¿‡ API è¯·æ±‚ä½“ä¸­çš„ `size` å‚æ•°æ˜ç¡®æŒ‡å®šã€‚

---

å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©æ‚¨æˆåŠŸéƒ¨ç½²å’Œä½¿ç”¨è¿™ä¸ª Cloudflare Workerï¼
